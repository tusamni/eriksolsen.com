---
// layout
import Layout from "@/layouts/BaseLayout";

// components
import { supabase } from "@/library/supabase";
import { Markdown } from "astro-remote";
import { timeAgo, formatDate } from "@/functions/DateTime";
import Container from "@/components/content/Container";
import Figure from "@/components/image/Figure";
import Heading from "@/components/content/Heading";
import Related from "@/components/blog/related/Primary";
import Section from "@/components/content/Section";
import Split from "@/components/content/Split";

// content
const { slug } = Astro.params;

// select all posts with the same slug
const { data, error } = await supabase.from("posts").select("*, category(*)").eq("slug", slug).limit(1);
const post = data[0];

// if no post, return 404
if (!post) return Astro.redirect("/404");

// get posts related to the current slug
const related = await supabase.rpc("get_related_posts", { post_vector: post.vector, post_id: post.id });
---

<Layout title={post.title} description={post.description}>
    <Section>
        <Container>
            <Heading>
                <h1 slot="heading">{post.title}</h1>
                <div slot="middle" class="flex flex-row gap-3">
                    <time class="pill pill-secondary" datetime={formatDate(post.created_at)}>
                        {timeAgo(new Date(post.created_at))}
                    </time>

                    <div class="pill pill-primary">{post.category.content}</div>
                </div>
                <div slot="description">{post.excerpt}</div>
            </Heading>
        </Container>

        <Container>
            <Split size="large" float={true} reverse={true}>
                <div slot="heading" class="space-y-20 w-4/5">
                    {
                        related && (
                            <div class="space-y-8">
                                <div class="h4">Related Posts</div>
                                {related.data.map((r) => (
                                    <Related post={r} />
                                ))}
                            </div>
                        )
                    }
                </div>

                <article class="prose prose-lg">
                    <Markdown content={post.content} sanitize={{ allowComponents: true }} components={{ Figure }} />
                </article>
            </Split>
        </Container>
    </Section>
</Layout>
